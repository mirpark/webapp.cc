<!DOCTYPE html> 
<html> 
	<head> 
	<title>Dynamic Listview - JQM</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
	<!-- JQM -->
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
	<!-- Plugins -->
	<script type="text/javascript" src="http://ragingwind.github.com/js/jquery/jquery.url.js"></script>
	<!-- Local -->
	<script type="text/javascript" charset="utf-8">
	var controller = {
		init: function() {
			$(document).bind( "pagebeforechange", function( e, data ) {
				if ( typeof data.toPage === "string" ) {
					var u = $.mobile.path.parseUrl( data.toPage ),
						re = /^#category-item/;

					if ( u.hash.search(re) !== -1 ) {
						controller.router($.mobile.path.parseUrl( data.toPage ), data.options);
						e.preventDefault();
					}
				}
			});
		},
		changePage: function(target, jsonPath, options, dataUrl) {
			if (!jsonPath) return;
			
			$.getJSON(jsonPath, function(category) {
				// Generate list with category items.
				var markup = "<p>" + category.name + "</p><ul data-role='listview' data-inset='true'>";
				for ( var i = 0, items = category.items, count = items.length; i < count; i++ ) {
					markup += "<li>" + items[i].name + "</li>";
				}
				markup += "</ul>";

				// Make a JQM page with generated markup.
				var $page = $( target ),
					$header = $page.children( ":jqmData(role=header)" ),
					$content = $page.children( ":jqmData(role=content)" );


				// Set category name to header
				$header.find( "h1" ).html( category.name );
				
				// Set list to content
				$content.html( markup );

				// Enhance page and the listview.
				$page.page();
				$content.find( ":jqmData(role=listview)" ).listview();

				// Set dataURL to new href
				options.dataUrl = dataUrl;
				
				// Change the page
				$.mobile.changePage( $page, options );
			});	
		},
		routes: {
			animals:"animals.json",
			colors:"colors.json",
			vehicles:"vehicles.json"
		},
		router: function(pageUrl, options) {
			// remove hash in head character. 
			var url = $.url( pageUrl.hash.replace( /^#/, "" ) ),	// remomve hash for parsing url.
				target = "#" + url.attr("host"); // category-items -> #category-items.
				params = url.param(), // get parameter from category=animals.
				jsonPath = this.routes[params.category]; // get json path from routes.
				
			controller.changePage(target, jsonPath, options, pageUrl.href);
		}
	};
	
	controller.init();
</script>
</head> 
<body> 
<!-- Root page -->
<div id="home" data-role="page" class="ui-scrolllistview">
	<div data-role="header"><h1>Categories</h1></div>
		<div data-role="content" >
			<ul data-role="listview">
				<li><a href="#category-items?category=animals">Animals</a></li>
				<li><a href="#category-items?category=colors">Colors</a></li>
				<li><a href="#category-items?category=vehicles">Vehicles</a></li>
			</ul>
		</div>
	</div>
</div>

<!-- Category-items page template -->
<div id="category-items" data-role="page">
<div data-role="header">
	<a href="#" data-rel="back">Back</a>
	<h1></h1>
</div>
<div data-role="content"></div>
</div>
</body>
</html>
